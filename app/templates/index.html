<!doctype html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="utf-8">
  <title>JMeter Controller</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Custom CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='app.css') }}">
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg bg-dark shadow-sm sticky-top">
    <div class="container">
      <span class="navbar-brand d-flex align-items-center text-light fw-bold">
        <i class="bi bi-speedometer2 me-2"></i> JMeter Controller
      </span>
      <div class="ms-auto d-flex gap-2">
        <button id="themeToggle" class="btn btn-outline-light btn-sm">
          <i class="bi bi-sun-fill me-1"></i>Theme
        </button>
      </div>
    </div>
  </nav>

  <!-- Main content -->
  <main class="container py-4">

    <!-- Controls -->
    <div class="card shadow-lg border-0 mb-4">
      <div class="card-body d-flex flex-wrap align-items-center gap-2">
        <input id="file" type="file" accept=".jmx" class="form-control w-auto">
        <button id="uploadBtn" class="btn btn-primary">
          <i class="bi bi-upload me-1"></i>Upload
        </button>

        <button id="startBtn" class="btn btn-success" disabled>
          <i class="bi bi-play-fill me-1"></i>Start
        </button>
        <button id="stopBtn" class="btn btn-danger" disabled>
          <i class="bi bi-stop-fill me-1"></i>Stop
        </button>

        <!-- JTL / summary downloads -->
        <a id="dlJtl" class="btn btn-outline-secondary disabled" href="#">
          <i class="bi bi-filetype-csv me-1"></i>Download JTL
        </a>
        <a id="dlSummary" class="btn btn-outline-secondary disabled" href="#">
          <i class="bi bi-clipboard-data me-1"></i>Download summary
        </a>

        <!-- Report controls -->
        <button id="genReport" class="btn btn-outline-primary" disabled>
          <i class="bi bi-bar-chart-line me-1"></i>Generate HTML Report
        </button>
        <a id="dlReportZip" class="btn btn-outline-secondary disabled" href="#">
          <i class="bi bi-file-zip me-1"></i>Download Report (zip)
        </a>
      </div>

      <!-- Distributed configuration -->
      <div class="card-body border-top">
        <div class="row g-3 align-items-end">
          <!-- Test type -->
          <div class="col-md-3">
            <label class="form-label mb-1">Test Type</label>
            <select id="testType" class="form-select w-100">
              <option value="sanity">Sanity (single engine)</option>
              <option value="distributed">Distributed</option>
            </select>
          </div>

          <!-- Distribution mode (visible only in distributed) -->
          <div class="col-md-4">
            <label class="form-label mb-1">Distribution Mode</label>
            <select id="distMode" class="form-select w-100" style="display:none;">
              <option value="replicate">Replicate plan per slave (multiply total)</option>
              <option value="split_equal">Split equally (control total)</option>
            </select>
          </div>

          <!-- Remote hosts & #slaves (visible only in distributed) -->
          <div class="col-md-5">
            <label class="form-label mb-1">Remote hosts (comma-separated)</label>
            <input id="remoteHosts" class="form-control"
                   placeholder="e.g. 10.4.128.145,10.4.128.146" style="display:none;">
          </div>

          <div class="col-md-2">
            <label class="form-label mb-1"># Slaves</label>
            <input id="numSlaves" class="form-control" type="number" placeholder="e.g. 2"
                   style="display:none;">
          </div>

          <!-- Split method (visible only when split_equal) -->
          <div class="col-md-3">
            <label class="form-label mb-1">Split Method</label>
            <select id="splitMethod" class="form-select w-100" style="display:none;">
              <option value="tps">Split TPS (uses Constant Throughput Timer)</option>
              <option value="threads">Split Threads (uses Thread Group)</option>
            </select>
          </div>

          <!-- TPS total (visible when split_method = tps) -->
          <div class="col-md-3">
            <label class="form-label mb-1">Total TPS</label>
            <input id="totalTps" class="form-control" type="number" placeholder="e.g. 400"
                   style="display:none;">
          </div>

          <!-- Thread-based split fields (visible when split_method = threads) -->
          <div class="col-md-3">
            <label class="form-label mb-1">Total Threads</label>
            <input id="totalThreads" class="form-control" type="number" placeholder="e.g. 300"
                   style="display:none;">
          </div>
          <div class="col-md-2">
            <label class="form-label mb-1">Ramp-up (s)</label>
            <input id="rampup" class="form-control" type="number" placeholder="e.g. 60"
                   style="display:none;">
          </div>
          <div class="col-md-2">
            <label class="form-label mb-1">Duration (s, optional)</label>
            <input id="duration" class="form-control" type="number" placeholder="e.g. 900"
                   style="display:none;">
          </div>

          <!-- Help -->
          <div class="col-12">
            <small class="text-muted" id="rmiHelp" style="display:none;">
              Remote testing requires JMeter servers running & reachable (same JMeter/Java versions; open RMI ports).
              See <a href="https://jmeter.apache.org/usermanual/remote-test.html" target="_blank">
              JMeter remote testing</a>.
            </small>
          </div>
        </div>
      </div>
    </div>

    <!-- KPI Cards -->
    <div class="row g-4 mb-4 text-center">
      <div class="col-md-2">
        <div class="card shadow-sm border-0">
          <div class="card-body">
            <i class="bi bi-hash text-secondary fs-3"></i>
            <h6 class="mt-2">Session</h6>
            <p class="display-6 mb-0"><span id="sid">â€”</span></p>
          </div>
        </div>
      </div>
      <div class="col-md-2">
        <div class="card shadow-sm border-0">
          <div class="card-body">
            <i class="bi bi-info-circle text-info fs-3"></i>
            <h6 class="mt-2">Status</h6>
            <p class="display-6 mb-0"><span id="state">idle</span></p>
          </div>
        </div>
      </div>
      <div class="col-md-2">
        <div class="card shadow-sm border-0">
          <div class="card-body">
            <i class="bi bi-clock-history text-primary fs-3"></i>
            <h6 class="mt-2">Elapsed</h6>
            <p class="display-6 mb-0"><span id="elapsed">0</span>s</p>
          </div>
        </div>
      </div>
      <div class="col-md-2">
        <div class="card shadow-sm border-0">
          <div class="card-body">
            <i class="bi bi-people-fill text-warning fs-3"></i>
            <h6 class="mt-2">VUs</h6>
            <p class="display-6 mb-0" id="vus">0</p>
          </div>
        </div>
      </div>
      <div class="col-md-2" id="passedBadge">
        <div class="card shadow-sm border-0">
          <div class="card-body">
            <i class="bi bi-check-circle text-success fs-3"></i>
            <h6 class="mt-2">Passed</h6>
            <p class="display-6 mb-0" id="pass">0</p>
          </div>
        </div>
      </div>
      <div class="col-md-2" id="failedBadge">
        <div class="card shadow-sm border-0">
          <div class="card-body">
            <i class="bi bi-x-circle text-danger fs-3"></i>
            <h6 class="mt-2">Failed</h6>
            <p class="display-6 mb-0" id="fail">0</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Second KPI row -->
    <div class="row g-4 mb-4 text-center">
      <div class="col-md-6">
        <div class="card shadow-sm border-0">
          <div class="card-body">
            <i class="bi bi-bug-fill text-danger fs-3"></i>
            <h6 class="mt-2">Errors</h6>
            <p class="display-6 mb-0" id="err">0</p>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card shadow-sm border-0">
          <div class="card-body">
            <i class="bi bi-graph-up-arrow text-info fs-3"></i>
            <h6 class="mt-2">Hits/sec</h6>
            <p class="display-6 mb-0" id="hps">0</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Charts -->
    <div class="row g-4">
      <div class="col-md-4">
        <div class="card shadow-sm border-0">
          <div class="card-header fw-semibold"><i class="bi bi-activity me-2"></i>Hits/sec</div>
          <div class="card-body"><canvas id="hitsChart" height="160"></canvas></div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card shadow-sm border-0">
          <div class="card-header fw-semibold"><i class="bi bi-lightning-charge me-2"></i>Throughput (B/s)</div>
          <div class="card-body"><canvas id="thrChart" height="160"></canvas></div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card shadow-sm border-0">
          <div class="card-header fw-semibold"><i class="bi bi-stopwatch me-2"></i>Avg response (ms)</div>
          <div class="card-body"><canvas id="respChart" height="160"></canvas></div>
        </div>
      </div>
    </div>

    <!-- Footer note -->
    <div class="text-muted small mt-4">
      <i class="bi bi-shield-lock me-1"></i>
      This demo stores files temporarily for the duration of your test. Download results after completion.
    </div>
  </main>

  <!-- Transactions Modal -->
  <div class="modal fade" id="txnModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
      <div class="modal-content shadow-lg border-0">
        <div class="modal-header bg-dark text-light">
          <h5 class="modal-title"><i class="bi bi-list-check me-2"></i>Transactions</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-md-8">
              <div class="mb-3">
                <input type="text" id="txnFilter" class="form-control"
                       placeholder="Filter by label (e.g. Login)">
              </div>
              <div class="table-responsive">
                <table class="table table-hover table-sm align-middle">
                  <thead class="table-dark">
                    <tr>
                      <th>Label</th>
                      <th>Status</th>
                      <th>Code</th>
                      <th>Elapsed (ms)</th>
                    </tr>
                  </thead>
                  <tbody id="txnTable"></tbody>
                </table>
              </div>
            </div>
            <div class="col-md-4 d-flex align-items-center justify-content-center">
              <canvas id="txnChart" width="200" height="200"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="{{ url_for('static', filename='app.js') }}"></script>
</body>
</html>
